{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/Automate-React-Native-Deployment-Part-1/","result":{"data":{"site":{"siteMetadata":{"title":"Timmy Willison","author":"Timmy Willison"}},"markdownRemark":{"id":"b933d3a4-8ac3-5ce7-bfe9-f9af94a9e1db","excerpt":"I’m a fan of React Native. It allows me to build native mobile apps using JavaScript. That’s no small feat, but no tool is perfect. React Native has its…","html":"<p>I’m a fan of React Native. It allows me to build native mobile apps using JavaScript. That’s no small feat, but no tool is perfect. React Native has its frustrating quirks and time-consuming challenges, as any library as heavy as React Native might. Automating deployment has been one of those challenges. I’ve fiddled with deployment processes across several projects over the years and I was never really satisfied with the results. It took many iterations: adding new tools, removing stale ones, using old tools in new ways, but I recently realized that I reached my goal.</p>\n<p>I should point out that I didn’t create some silver bullet to the deployment problem. I am simply using existing tools in intended, documented ways. Look at any individual piece, and there’s nothing original. What I believe is special, and what I am excited to share, is the way the tools are combined to form a seamless, single-command, automated deployment process from commit to app store.</p>\n<p>Part 1 will establish some project assumptions that are required for this process to work, and then walk through the first half of the setup. This is meant to be an example of what is possible. Some of these tools have alternatives that would be relatively easy to swap–such as Circle CI with pretty much any other CI–but I’m going to stick with what I used and maybe you can take it from there.</p>\n<p>To see everything put together, check out <a href=\"https://github.com/timmywil/react-native-deployment-example\">the working example repo with all code samples</a>.</p>\n<h2>Bird’s eye view</h2>\n<p>When this series is complete, you should have a working deployment flow that runs with one command: <code>yarn release</code> (or <code>npm run release</code>). Here’s an overview of the whole process:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/609085edace92364601c3dae405e83be/1dbe8/rn-deployment-diagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 170.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"React Native Automated Deployment\"\n        title=\"\"\n        src=\"/static/609085edace92364601c3dae405e83be/fcda8/rn-deployment-diagram.png\"\n        srcset=\"/static/609085edace92364601c3dae405e83be/12f09/rn-deployment-diagram.png 148w,\n/static/609085edace92364601c3dae405e83be/e4a3f/rn-deployment-diagram.png 295w,\n/static/609085edace92364601c3dae405e83be/fcda8/rn-deployment-diagram.png 590w,\n/static/609085edace92364601c3dae405e83be/efc66/rn-deployment-diagram.png 885w,\n/static/609085edace92364601c3dae405e83be/c83ae/rn-deployment-diagram.png 1180w,\n/static/609085edace92364601c3dae405e83be/1dbe8/rn-deployment-diagram.png 1374w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><em>Note: e2e testing is not part of this flow. It assumes the previous commit has already passed all tests. Setting up testing for supported devices in CI is another beast. I may share that in a later post.</em></p>\n<h3>You know what happens when you assume</h3>\n<p>This workflow assumes some things about the project. It assumes you have a project structure similar to mine. That is, similar to the one generated by <code>react-native init</code>. Most of this should work in an expo project, but I haven’t used expo that much so I can’t say for sure.</p>\n<h4>Commit message guidelines</h4>\n<p>The critical assumption is that all commits for the release follow some commit message guidelines. This is necessary for determining a proper <a href=\"https://semver.org/\">semantic version</a> and generating release notes from commit messages.</p>\n<p>You’re not tied to the <a href=\"https://www.conventionalcommits.org\">format I use</a>, but each commit should at least have a scope, a subject, and some keyword to denote a breaking change. There are several possible presets. Have a look at <a href=\"https://github.com/semantic-release/commit-analyzer#configuration\">@semantic-release/commit-analyzer</a> for the possible configs. I also recommend checking out <a href=\"https://github.com/conventional-changelog/commitlint#readme\">commitlint</a> and <a href=\"https://github.com/typicode/husky#readme\">husky</a> for enforcing commit message guidelines on commit. <a href=\"https://commitizen.github.io/cz-cli/\">commitizen</a> is nice if you’d like a prompt to use when committing. The config I use for this blog is available on my <a href=\"https://github.com/timmywil/timmywil.github.io\">GitHub</a>. Check out the <a href=\"https://github.com/timmywil/timmywil.github.io/blob/decfa4eceab3a840ecd3969ca346c65ecf5ef7a6/package.json#L95\">package.json</a> and <a href=\"https://github.com/timmywil/timmywil.github.io/blob/decfa4eceab3a840ecd3969ca346c65ecf5ef7a6/commitlint.config.js\">commitlint.config.js</a></p>\n<h4>[TypeScript]</h4>\n<p>It’s not necessary that you use TypeScript, but a few of my code examples will use the TypeScript compiler and <a href=\"https://github.com/palantir/tslint\">tslint</a>. You could swap those with tools such as <a href=\"https://eslint.org/\">eslint</a>. <a href=\"https://github.com/prettier/prettier\">prettier</a> works with both TypeScript and Vanilla JavaScript.</p>\n<h2>Dependencies for part 1</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span> <span class=\"token function\">add</span> <span class=\"token parameter variable\">--dev</span> <span class=\"token punctuation\">\\</span>\nsemantic-release <span class=\"token punctuation\">\\</span>\n@semantic-release/git <span class=\"token punctuation\">\\</span>\nreact-native-version</code></pre></div>\n<h2>Setting up semantic-release</h2>\n<p>Add this script to your <code>package.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"release\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"semantic-release\"</span>\n  ...\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, double check <a href=\"https://github.com/semantic-release/git#git-authentication\">git authentication</a>, which involves setting some environment variables. Then create a GitHub token for semantic-release-bot. The <a href=\"https://github.com/semantic-release/github#github-authentication\">@semantic-release/github docs</a> explain how to do this. Specifically, follow <a href=\"https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line\">this guide</a> and set <code>GH_TOKEN</code> in your environment. The token will allow the semantic-release-bot to use the GitHub API to push release notes.</p>\n<p>Here’s an example config to use for semantic-release.\nReplace <code>$PROJECTNAME</code> with your own project name.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"release\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Release from this branch</span>\n  <span class=\"token property\">\"branch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"master\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// This isn't an npm package</span>\n  <span class=\"token property\">\"npmPublish\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// We're initiating the release from</span>\n  <span class=\"token comment\">// our local machine. You could set this</span>\n  <span class=\"token comment\">// to true and set up releasing on every push</span>\n  <span class=\"token comment\">// to the release branch, but I like</span>\n  <span class=\"token comment\">// pulling the trigger myself.</span>\n  <span class=\"token property\">\"ci\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// Analyzes commit messages and</span>\n    <span class=\"token comment\">// determines the version</span>\n    <span class=\"token string\">\"@semantic-release/commit-analyzer\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Builds release notes from commit messages</span>\n    <span class=\"token string\">\"@semantic-release/release-notes-generator\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Updates the version</span>\n    <span class=\"token string\">\"@semantic-release/npm\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">// Commits, tags, and pushes</span>\n      <span class=\"token string\">\"@semantic-release/git\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"assets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"ios/$PROJECTNAME*/Info.plist\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"ios/$PROJECTNAME.xcodeproj/project.pbxproj\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"android/app/build.gradle\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"package.json\"</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"chore(release): ${nextRelease.version} \\n\\n${nextRelease.notes}\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Creates the release on GitHub</span>\n    <span class=\"token comment\">// and posts release notes</span>\n    <span class=\"token string\">\"@semantic-release/github\"</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Updating the version</h3>\n<p>There’s an important package that works in conjunction with <code>@semantic-release/npm</code> that makes releasing to the app store possible. If we stopped here, only the version in <code>package.json</code> would get updated, resulting in errors later on CI when deploying to the app stores. <a href=\"https://github.com/stovmascript/react-native-version#readme\">react-native-version</a> is needed to update the versions in android and ios.<sup><a href=\"#notes\">1</a></sup> It piggybacks off of the command used to update the <code>package.json</code> version and uses the same version to update android and ios files.</p>\n<p>Make sure it’s installed and add this to your <code>package.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"postversion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"react-native-version --never-amend\"</span>\n  ...\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Side note: you can add <code>pre</code> or <code>post</code> to any script and it will run before or after that script. That includes custom scripts, by the way.</p>\n<h3>The git commit</h3>\n<p>After updating the version, <code>@semantic-release/git</code> is responsible for staging the changed assets, committing those assests, tagging the commit, and pushing it to GitHub. But you have to be explicit about which files to add. The files listed above are all of the files that <code>@semantic-release/npm</code> and <code>react-native-version</code> changes.</p>\n<p>The message is mostly default with one important difference. It removes <code>[skip ci]</code> from the end of the message. We do not want to skip CI.</p>\n<h3>Signing commits with GPG</h3>\n<p>If you already have GPG set up for signing commits <sup><a href=\"#notes\">2</a></sup>, you may also want to enable signing commits and tags made by semantic-release. This is easy to do in our case since we’re committing from our local machine. The fix is to commit using your own name and email rather than than the default name and email used for the bot. <sup><a href=\"#notes\">3</a></sup> Make sure these environment variables are set to the ones matching your GPG signature:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">GIT_AUTHOR_NAME\nGIT_AUTHOR_EMAIL\nGIT_COMMITTER_NAME\nGIT_COMMITTER_EMAIL</code></pre></div>\n<p>If you opted to run semantic-release in CI, the <a href=\"https://github.com/semantic-release/git#gpg-signature\"><code>@semantic-release/git</code> docs</a> explain how to sign commits on Travis.</p>\n<h3>Conclusion</h3>\n<p>Try running <code>yarn release -d</code> or <code>npm run release -- -d</code> to do a dry run of what you have so far. If everything is set up correctly, you’re halfway to single-command deployment. In the next part, we’ll discuss setting up fastlane and Circle CI, which will take care of linting, building, and actually deploying to Testflight and Google Play, as well as posting a message to Slack.</p>\n<p><a name=\"notes\"></a></p>\n<details>\n<summary>Notes</summary>\n<style>small, small code { font-size: 80%; line-height: 1; }</style>\n<p><small><strong>1</strong>: If you’ve used fastlane before, you may have used that to update versions in iOS and Android and are wondering why this is better. First, this does more than existing fastlane plugins. For example, while it’s easy to increment the version code in Android using a fastlane plugin, it’s not so easy to update the version name at the same time, which should really match the version we use in <code>package.json</code>. But the main reason to use <code>react-native-version</code> is using fastlane in CI is too little too late. If we tried to update versions when deploying to the app stores, we’d have to jump through several hoops to get those changes included in our git tag. We want a clean, atomic release, and git tags are perfect for that. fastlane would have to amend the commit and tag. Overall, it’s simpler to do it when updating the <code>package.json</code> version. You may also be wondering why we’re using fastlane on CI instead of our local machine. We’ll get to that in part 2.</small></p>\n<p><small><strong>2</strong>: A while back I wrote <a href=\"https://medium.com/@timmywil/sign-your-commits-on-github-with-gpg-566f07762a43\">a guide</a> on signing commits with GPG, including saving the passphrase so you don’t have to enter it every commit.</small></p>\n<p><small><strong>3</strong>: I ran into an issue with this. I had the environment variables defined in my <code>.bash_profile</code>, but wasn’t using <code>export</code> (e.g. <code>export GIT_AUTHOR_EMAIL=$EMAIL</code> rather than <code>GIT_AUTHOR_EMAIL=$EMAIL</code>). The reason for <code>export</code> is to make the variable available to other processes, like <code>node</code>. Make sure to use <code>export</code>.</small></p>\n</details>","frontmatter":{"title":"Automate React Native Deployment - Part 1","date":"May 06, 2019","description":null}}},"pageContext":{"slug":"/blog/Automate-React-Native-Deployment-Part-1/","previous":{"fields":{"slug":"/blog/new-blog/"},"frontmatter":{"title":"New Blog!"}},"next":{"fields":{"slug":"/blog/Automate-React-Native-Deployment-Part-2/"},"frontmatter":{"title":"Automate React Native Deployment - Part 2"}}}},"staticQueryHashes":["2149165137","495387789","63159454"],"slicesMap":{}}