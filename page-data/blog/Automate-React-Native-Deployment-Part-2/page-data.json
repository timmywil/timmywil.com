{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/Automate-React-Native-Deployment-Part-2/","result":{"data":{"site":{"siteMetadata":{"title":"Timmy Willison","author":"Timmy Willison"}},"markdownRemark":{"id":"023269c5-6135-5d02-b889-5b39631f9036","excerpt":"In part 1, we discussed how to set up semantic-release and react-native-version. That covers the first part of the deployment flow from commit to GitHub. In…","html":"<p>In <a href=\"../Automate-React-Native-Deployment-Part-1/\">part 1</a>, we discussed how to set up <a href=\"https://github.com/semantic-release/semantic-release\">semantic-release</a> and <a href=\"https://github.com/stovmascript/react-native-version\">react-native-version</a>. That covers the first part of the deployment flow from commit to GitHub. In this post, we’ll take a look at the configs for verification and deployment. The CI configs shared in this post are for Circle CI, but the workflow can be applied to any CI. A working example repo can be found <a href=\"https://github.com/timmywil/react-native-deployment-example\">here</a>. Here’s what we’ll cover:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7984e2cf2d593c71355813caad6cfbd/7798c/rn-deployment-diagram-part-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADRElEQVQ4y4WUa2xTdRjGf23P2q2CLOBtG7sUOxWk7EKHZaxjW8S5uGjinGXWSLb2nLanDBaiYUGiLEQIEWZ7tvW0DjNGjIYgamL8Trh894sftAaIl2QzJg51iHFnx/wPXQzZlCd5T97zf5I3z3ne53/o5XBrH0faQrzVHuZYSwcDLwYJh8Ic3yHOdvN2ex8jzdX41gKVNmyVwDrAzt2wWc8IqYU4mcUYE0bSqS8mi7LGYHHOSLqyiwoTRpyMKaPN7aDXD2yQcG4ERO8FaoDHgWrgUcGjMG7uZdJMkDMPlX1oHqk9Zx7ddN4cqT1nnQlODO1CrQNKiln1MPAUsA14Amgr9GsAB/2cvCijXY6SviRqgPeu9DN6deldJn01QurLBjp9QJ0dh7+gsB5oAJYUN1k27CK6pYtEYyexhm72+5p4vq2Rrl3dDPk6URqftThlcy3bnIDkQCqylIAkFAPFhbrPGhglPZ9AvxUnc0t1ZOdVSf9TlfTbSSk7HycjuL9kxn5+mshm8VlO3GVAObCalfCvh1nzUPkdD4/VXTAPV31keZi0PNQXdhIWPvkcSEGgHXjsru0uoZ+T38ho38mk84pdyyv2sXxcGs8rNi0vk/5WRrs2wKmvnmPvBsDlxP0gIGrVigp3Eq7qsO/x+HnJE+C1ygq21j+Er2krr64P8LKnw7bH08orVUOctRXh4p6IkPo1Rubm0JrJmwfWfjB3sHLqj+HqqfmDZWfmBt25uRgTv8ukf3oGWWzzficlwr9HRP+fHqq8b75eesZ8x/eJecL/mTka/MI8Xn/BPLB6yuIS6H+3sDsgYuNAagZaC0FejiipmTj6rOrQZ0ee/Hh2uHx6Zrji7MxwxbQ4E9wvwsduBmsBd0GhqNIVBzbT4wnaQt4APd5NvFBTQ5O/grqAn1D1dnq8LYS82+mp6eVNm4Tz3h4OcOqawtgNGe1GFO16hNQPUVI/il5Gu64w9n2E0a+7SIi763bd2fID/5tDkbc31k2bJ/yfWhk8uvG8+W7gc8tDwcXRbwfpEzncUshha+HHsBwymqGSM1R7ztjnmjT2l5w2BosmjX3Fpw3VlltQyZkxxn/rJCbucqmTkvVAVSGLy/APhEUlU1wuO58AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Automate React Native Deployment Part 2\"\n        title=\"Automate React Native Deployment Part 2\"\n        src=\"/static/b7984e2cf2d593c71355813caad6cfbd/fcda8/rn-deployment-diagram-part-2.png\"\n        srcset=\"/static/b7984e2cf2d593c71355813caad6cfbd/12f09/rn-deployment-diagram-part-2.png 148w,\n/static/b7984e2cf2d593c71355813caad6cfbd/e4a3f/rn-deployment-diagram-part-2.png 295w,\n/static/b7984e2cf2d593c71355813caad6cfbd/fcda8/rn-deployment-diagram-part-2.png 590w,\n/static/b7984e2cf2d593c71355813caad6cfbd/efc66/rn-deployment-diagram-part-2.png 885w,\n/static/b7984e2cf2d593c71355813caad6cfbd/c83ae/rn-deployment-diagram-part-2.png 1180w,\n/static/b7984e2cf2d593c71355813caad6cfbd/7798c/rn-deployment-diagram-part-2.png 1183w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><em>Disclaimer: this might be hard to set up from scratch. It will be easier for those with existing projects to migrate to this workflow and make changes where things are different.</em></p>\n<h2>Verification</h2>\n<p>The purpose of this verification step is to run some sanity checks, not to run the full test suite. That should already have been done using the same package on the previous commit. The only changes to the package should be the version number edits, so we run some simple linting checks and perhaps the unit tests.</p>\n<p>We also want to keep the deployment as reliable and fast as possible. If you have experience running integration or e2e tests for React Native apps in CI, you’ll know that “reliable” and “fast” are usually not words used to describe those types of tests, especially when running tests for both iOS and Android on multiple supported devices.</p>\n<p>Here’s a sample config for a simple job that installs node dependencies, lints, runs unit tests, and saves the workspace for later use. We’re using <code>yarn</code> here, but if you prefer <code>npm</code>, swap <code>yarn.lock</code> with <code>package-lock.json</code> and edit <code>yarn</code> commands to use <code>npm run</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n<span class=\"token key atrule\">references</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">restore_yarn_cache</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;restore_yarn_cache</span>\n    <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">keys</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># when lock file changes, use increasingly general patterns to restore cache</span>\n        <span class=\"token punctuation\">-</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>v1<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"yarn.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">-</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>v1<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>\n        <span class=\"token punctuation\">-</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>v1<span class=\"token punctuation\">-</span>\n\n  <span class=\"token key atrule\">save_yarn_cache</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;save_yarn_cache</span>\n    <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> node_modules/\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>v1<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"yarn.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">verify</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ~/project\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/node<span class=\"token punctuation\">:</span><span class=\"token number\">10</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*restore_yarn_cache</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> yarn <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*save_yarn_cache</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Lint\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> yarn lint\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Unit tests\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> yarn test<span class=\"token punctuation\">:</span>unit\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">persist_to_workspace</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">root</span><span class=\"token punctuation\">:</span> ~/project\n          <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> node_modules</code></pre></div>\n<p>There are lots of unit test setups so I won’t cover that here, but I will share the way I lint TypeScript files. It took a few iterations to keep type checking, linting, and format checking under 10 secs. The answer was to use <a href=\"https://github.com/kimmobrunfeldt/concurrently#readme\">concurrently</a>. The three tasks do not need to run in sequence, so we can save time by running them all <em>concurrently</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token property\">\"type-check\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc -p tsconfig.json --noEmit\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"tslint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tslint -p tsconfig.json -c tslint.json\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"prettier\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"prettier --check \\\"**/*.tsx\\\" \\\"**/*.ts\\\" \\\"**/*.js\\\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"concurrently \\\"yarn type-check\\\" \\\"yarn tslint\\\" \\\"yarn prettier\\\"\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Your <code>.prettierignore</code> file should include <code>node_modules/**</code>, <code>ios/**</code>, <code>android/**</code>, and any other files you don’t want to check. Also note that this <code>lint</code> task is not meant to be used on commit. For something like that, you’d only want to check staged files. <a href=\"https://github.com/nrwl/precise-commits\">precise-commits</a> is great for checking <code>prettier</code> formatting on changed files.</p>\n<h2>Why fastlane in CI?</h2>\n<p>Setting up fastlane in CI rather than using it on a local machine has several advantages. One advantage is idempotent builds. The environment in which the apps are built will be the same each time, which provides some peace of mind when combatting build or deployment problems. Once it works, it’s repeatable. That’s not to say it’s not challenging to set up, but it’s worth it.</p>\n<p>Once upon a time, I deployed from my local machine without running <code>npm install</code>. I ended up delivering versions of node modules I was using on another branch. Needless to say, I had to release all over again. While there are ways to prevent that on a local machine, deploying from CI guarantees various problems like that don’t happen.</p>\n<p>Another advantage is that CI can run the deployments to iOS and Android concurrently. If you ran them on a local machine, you’d probably run one, wait for it to finish, and then run the other, which takes more time.</p>\n<p>Finally, running fastlane in CI allows any team member to deploy the app as long as they have the permissions to create the tag. No additional setup required, such as setting up environment variables or accessing Google Play release credentials that shouldn’t be committed. All of it is in CI environment variables.</p>\n<h2>Setting up fastlane in Circle CI</h2>\n<p>fastlane is pretty much the standard for automating beta deployments of iOS and Android apps, so I expect you’ve used it before or at least familiar with it. But even if you’re not, the <a href=\"https://docs.fastlane.tools/\">fastlance docs</a> do a good job of explaining first-time setup. I’ll try to cover what’s relevant to setting up fastlane for Circle CI, but make sure to set up <code>fastlane/</code> folders in both the <code>ios/</code> and <code>android/</code> folders. You can do that by running <code>fastlane init</code> in each folder. It’s not completely necessary to do it this way, but I find it simpler and much more readable to keep the configs separate. The fastlane configs shared below will assume this directory structure.</p>\n<h3>fastlane installation</h3>\n<p><u><strong>Do not</strong></u> install fastlane using <code>gem install</code>. Instead, install fastlane using <a href=\"http://gembundler.com/\">bundler</a>. First, install bundler with <code>gem install bundler -v 1.17.3</code> (or the latest 1.x version)<sup><a href=\"#notes\">1</a></sup>, add the following files to your project, then run <code>bundle update</code> top-level.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># Gemfile</span>\nsource <span class=\"token string-literal\"><span class=\"token string\">\"https://rubygems.org\"</span></span>\n\ngem <span class=\"token string-literal\"><span class=\"token string\">\"fastlane\"</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># .bundle/config</span>\n<span class=\"token comment\"># Note the single '.'</span>\n<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span>\n<span class=\"token symbol\">BUNDLE_PATH</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"./vendor/bundle\"</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># ios/.bundle/config</span>\n<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span>\n<span class=\"token symbol\">BUNDLE_PATH</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"../vendor/bundle\"</span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># android/.bundle/config</span>\n<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span>\n<span class=\"token symbol\">BUNDLE_PATH</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"../vendor/bundle\"</span></span></code></pre></div>\n<p>This setup allows us to have separate fastlane folders for iOS and Android, but still share gems and manage them with a single <code>Gemfile</code>.</p>\n<p>Add <code>vendor/</code> to your <code>.gitignore</code>.</p>\n<p>Now run <code>bundle exec fastlane init</code> in both the <code>ios/</code> and <code>android/</code> folders. Using the manual setup option will allow you skip some steps and just get the necessary files in place. We’ll be editing the <code>Fastfile</code> in each folder.</p>\n<h3>Circle CI environment variables</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 528px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1dbd4a571be76417686ea443f3d1f62c/4af8e/circle-env-vars.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcklEQVQoz3VTga6iMBDs/3+hMVEfCoiFFlHaQqHMZTbCkTvfJpPdknR2drYo1/eoyhLWGJRlifv9DsayLBsY8zwjz3PcbjcURYHr9Spn1ufzGZfLBa/XC2qcZpjeofMB0zQJvhGmlITsdDrJ5ePxKDnLMhwOBzk/n0+omBKeY4SLM9ZYSfY1Gw3DIDnGuGWC6nkOIUAN04zGD9Au4DXG/9TtCb336PsezrktE+/3ezurtABxWRDTgnmn6puHvLD6TO8ej4fU9JA1LVBDCGiNQde2MHWNJf0dfR9UOI6jNKCf/zZdobQxOOcFsnuFS1GiNBa67WSMPTgSR6YirbXkqqokc1nrN6WtRdFY5I0RskzX+HnUsG2LdgdukGN3XSfL+S2UjxNq52FcgO49jB+2kdJulHWzVEUf2cRaK94Za+UOGypazt1OH4RpFqJvHhJN0wghwcWwAR80CQlZCv+S1loBPmTfng3By1S2KqTy9eGT8A9l1VGhnHHpAwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Circle CI Environment Variables\"\n        title=\"Circle CI Environment Variables\"\n        src=\"/static/1dbd4a571be76417686ea443f3d1f62c/4af8e/circle-env-vars.png\"\n        srcset=\"/static/1dbd4a571be76417686ea443f3d1f62c/12f09/circle-env-vars.png 148w,\n/static/1dbd4a571be76417686ea443f3d1f62c/e4a3f/circle-env-vars.png 295w,\n/static/1dbd4a571be76417686ea443f3d1f62c/4af8e/circle-env-vars.png 528w\"\n        sizes=\"(max-width: 528px) 100vw, 528px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Here are all of the Circle CI environment variables that we’ll be setting:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Used to upload to the Google Play Store</span>\nGOOGLE_PLAY_CREDS_JSON\nANDROID_KEYSTORE\nANDROID_KEY_ALIAS\nANDROID_STORE_PASSWORD\n<span class=\"token comment\"># fastlane suggests setting these</span>\n<span class=\"token comment\"># to avoid any issues with building and uploading</span>\n<span class=\"token comment\"># I think utf8 is the default,</span>\n<span class=\"token comment\"># but I set them anyway</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">LC_ALL</span></span><span class=\"token operator\">=</span>en_US.UTF-8\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">LANG</span></span><span class=\"token operator\">=</span>en_US.UTF-8\n<span class=\"token comment\"># Used to log into to the Apple Developor Portal</span>\n<span class=\"token comment\"># I use my work's Apple login</span>\nFASTLANE_USER\nFASTLANE_PASSWORD\n<span class=\"token comment\"># Passphrase you used to encrypt the certs repo</span>\n<span class=\"token comment\"># You set this when setting up fastlane match</span>\nMATCH_PASSWORD\n<span class=\"token comment\"># Used for slack notifications</span>\nSLACK_URL</code></pre></div>\n<h3>Android</h3>\n<p>Follow the docs for <a href=\"https://docs.fastlane.tools/getting-started/android/setup/#setting-up-supply\">setting up <code>supply</code> for fastlane</a>. That will walk you through the process of generating the Google Play credentials JSON, but rather than committing that file to the repo, we’re going to convert the JSON to a string and add it as the <code>GOOGLE_PLAY_CREDS_JSON</code> environment variable. Respect <a href=\"https://12factor.net/\">12-factor</a>! :)</p>\n<p>As a front-end dev, my homebase is the browser console. Open one up and copy the JSON.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">></span> <span class=\"token keyword\">var</span> o <span class=\"token operator\">=</span> $<span class=\"token constant\">PASTE_JSON_HERE</span>\n\n<span class=\"token operator\">></span> <span class=\"token function\">copy</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>That will remove newlines and give you a nice, single-line string for CI (and local environments for testing). Circle CI does not strictly require this, but I’ve found it useful for other CIs and for adding environment variables to my own <code>.bash_profile</code>. After pasting, add this reference to your Circle <code>config.yml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">references</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">create_google_play_key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;create_google_play_key</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create Google Play key\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> echo $GOOGLE_PLAY_CREDS_JSON <span class=\"token punctuation\">></span> android<span class=\"token punctuation\">-</span>developer<span class=\"token punctuation\">-</span>creds.json</code></pre></div>\n<p>This will write the JSON to a file so it can be read when fastlane builds. The JSON is not logged to the CI logs. Add <code>android-developer-creds.json</code> to your <code>.gitignore</code>.</p>\n<h4>Android code signing</h4>\n<p><code>ANDROID_KEYSTORE</code>, <code>ANDROID_KEY_ALIAS</code>, and <code>ANDROID_STORE_PASSWORD</code> are used to sign the Android release. I use the same password (<code>ANDROID_STORE_PASSWORD</code>) for both reading the keystore and signing. Some frown upon this, and you’re free to make them separate passwords and separate environment variables. Consult the <a href=\"https://developer.android.com/studio/publish/app-signing\">android developer docs</a> to set up Android code signing.</p>\n<p>The important issue for us is the way we store the binary <code>.keystore</code> file as an environment variable. The best solution I’ve found is a bit fancy: encode the file using base64 and then decode it in Circle CI on-demand.</p>\n<p>Once you’ve followed the android docs to generate the <code>.keystore</code> (or <code>.jks</code>) file, run this command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ openssl base64 <span class=\"token parameter variable\">-A</span> <span class=\"token parameter variable\">-in</span> path/to/release-key.keystore</code></pre></div>\n<p>Copy this value and paste it in Circle CI environment variables under <code>ANDROID_KEYSTORE</code>, then add this reference to your Circle config:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">references</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># ...</span>\n  <span class=\"token key atrule\">decode_android_key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;decode_android_key</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Decode Android keystore\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> echo $ANDROID_KEYSTORE <span class=\"token punctuation\">|</span> base64 <span class=\"token punctuation\">-</span>di <span class=\"token punctuation\">|</span> tee release<span class=\"token punctuation\">-</span>key.keystore app/release<span class=\"token punctuation\">-</span>key.keystore <span class=\"token punctuation\">></span>/dev/null</code></pre></div>\n<p>This will decode the value and add <code>.keystore</code> files in both the <code>android/</code> and <code>android/app/</code> folders, which is necessary later.</p>\n<p>The <code>>/dev/null</code> at the end is important or the keystore will get logged in the CI logs. If it’s a public repo, that would defeat the purpose of all this.</p>\n<p>Here’s the Circle config for the deploy job:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">references</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">create_google_play_key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;create_google_play_key</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create Google Play key\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> echo $GOOGLE_PLAY_CREDS_JSON <span class=\"token punctuation\">></span> android<span class=\"token punctuation\">-</span>developer<span class=\"token punctuation\">-</span>creds.json\n\n  <span class=\"token key atrule\">decode_android_key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;decode_android_key</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Decode Android keystore\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> echo $ANDROID_KEYSTORE <span class=\"token punctuation\">|</span> base64 <span class=\"token punctuation\">-</span>di <span class=\"token punctuation\">|</span> tee release<span class=\"token punctuation\">-</span>key.keystore app/release<span class=\"token punctuation\">-</span>key.keystore <span class=\"token punctuation\">></span>/dev/null\n\n  <span class=\"token key atrule\">gems_cache_key_android</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;gems_cache_key_android</span> android<span class=\"token punctuation\">-</span>bundle<span class=\"token punctuation\">-</span>v1<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"../Gemfile.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> arch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token key atrule\">gradle_cache_key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;gradle_cache_key</span> jars<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"gradle/wrapper/gradle<span class=\"token punctuation\">-</span>wrapper.properties\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"build.gradle\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"app/build.gradle\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token key atrule\">restore_gems_cache_android</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;restore_gems_cache_android</span>\n    <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*gems_cache_key_android</span>\n\n  <span class=\"token key atrule\">save_gems_cache_android</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;save_gems_cache_android</span>\n    <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*gems_cache_key_android</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> ../vendor/bundle\n\n  <span class=\"token key atrule\">restore_gradle_cache</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;restore_gradle_cache</span>\n    <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*gradle_cache_key</span>\n\n  <span class=\"token key atrule\">save_gradle_cache</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;save_gradle_cache</span>\n    <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*gradle_cache_key</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> ~/.gradle\n        <span class=\"token punctuation\">-</span> ~/.m2\n\n  <span class=\"token key atrule\">android_dependencies</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;android_dependencies</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Download Android Dependencies\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> ./gradlew androidDependencies\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy_android</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ~/project/android\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/android<span class=\"token punctuation\">:</span>api<span class=\"token punctuation\">-</span>28<span class=\"token punctuation\">-</span>node8<span class=\"token punctuation\">-</span>alpha\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">checkout</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/project\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">attach_workspace</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">at</span><span class=\"token punctuation\">:</span> ~/project\n\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*restore_gradle_cache</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*android_dependencies</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*save_gradle_cache</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*restore_gems_cache_android</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> bundle install\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*save_gems_cache_android</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*decode_android_key</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*create_google_play_key</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and deploy android APK\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> bundle exec fastlane deploy\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">store_artifacts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> app/build/outputs/apk/\n          <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> /apk/</code></pre></div>\n<p>The deploy job reuses the workspace we created in <a href=\"../Automate-React-Native-Deployment-Part-1/\">part 1</a>, rather than re-installing node modules. Android gradle dependencies and ruby gems are given their own caches for faster subsequent builds. The key creation references are used once dependencies are installed.</p>\n<p>Finally, it’s time to build and deploy the Android app using fastlane.</p>\n<h4>Deploying the Android app using fastlane</h4>\n<p>Here’s an example fastlane config for Android.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># android/fastlane/Fastfile</span>\ndesc <span class=\"token string-literal\"><span class=\"token string\">\"Build the Android app\"</span></span>\nlane <span class=\"token symbol\">:assemble_build</span> <span class=\"token keyword\">do</span>\n  properties <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"android.injected.signing.store.file\"</span></span> <span class=\"token operator\">=></span> <span class=\"token string-literal\"><span class=\"token string\">\"release-key.keystore\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"android.injected.signing.store.password\"</span></span> <span class=\"token operator\">=></span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'ANDROID_STORE_PASSWORD'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"android.injected.signing.key.alias\"</span></span> <span class=\"token operator\">=></span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'ANDROID_KEY_ALIAS'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"android.injected.signing.key.password\"</span></span> <span class=\"token operator\">=></span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'ANDROID_STORE_PASSWORD'</span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  gradle<span class=\"token punctuation\">(</span><span class=\"token symbol\">task</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"assemble\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">build_type</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Release\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">properties</span><span class=\"token operator\">:</span> properties<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\ndesc <span class=\"token string-literal\"><span class=\"token string\">\"Build and deploy to Google Play\"</span></span>\nlane <span class=\"token symbol\">:deploy</span> <span class=\"token keyword\">do</span>\n  assemble_build\n  <span class=\"token comment\"># Can be changed to another track (e.g. 'beta')</span>\n  upload_to_play_store<span class=\"token punctuation\">(</span><span class=\"token symbol\">track</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'alpha'</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>The environment is already set up for this to work. You can change the track to any track you like, but I usually start with alpha on a new project and then later upload directly to the beta track once the app is more mature. Test the build with <code>bundle exec fastlane assemble_build</code> from the <code>android/</code> folder.</p>\n<h3>iOS</h3>\n<p>First, here’s the config for Circle. Replace <code>$PROJECTNAME</code> with your project name.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">references</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># ...</span>\n  <span class=\"token comment\"># The node module cache for macos machines must</span>\n  <span class=\"token comment\"># be separate from the other node module cache</span>\n  <span class=\"token comment\"># because the home directory differs.</span>\n  <span class=\"token key atrule\">restore_yarn_cache_macos</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;restore_yarn_cache_macos</span>\n    <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">keys</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># when lock file changes, use increasingly general patterns to restore cache</span>\n        <span class=\"token punctuation\">-</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>macos<span class=\"token punctuation\">-</span>v4<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"yarn.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">-</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>macos<span class=\"token punctuation\">-</span>v4<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>\n        <span class=\"token punctuation\">-</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>macos<span class=\"token punctuation\">-</span>v4<span class=\"token punctuation\">-</span>\n  <span class=\"token key atrule\">save_yarn_cache_macos</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;save_yarn_cache_macos</span>\n    <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> node_modules/\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> yarn<span class=\"token punctuation\">-</span>packages<span class=\"token punctuation\">-</span>macos<span class=\"token punctuation\">-</span>v4<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> .Branch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"yarn.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token key atrule\">gems_cache_key_ios</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;gems_cache_key_ios</span> ios<span class=\"token punctuation\">-</span>bundle<span class=\"token punctuation\">-</span>v1<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"Gemfile.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> arch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">restore_gems_cache_ios</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;restore_gems_cache_ios</span>\n    <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*gems_cache_key_ios</span>\n  <span class=\"token key atrule\">save_gems_cache_ios</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;save_gems_cache_ios</span>\n    <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*gems_cache_key_ios</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> vendor/bundle\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># ...</span>\n  <span class=\"token key atrule\">deploy_ios</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">macos</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">xcode</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'10.1.0'</span>\n    <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ~/project\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">FL_OUTPUT_DIR</span><span class=\"token punctuation\">:</span> output\n    <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> /bin/bash <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>login <span class=\"token punctuation\">-</span>o pipefail\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*restore_yarn_cache_macos</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> yarn <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*save_yarn_cache_macos</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*restore_gems_cache_ios</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> bundle install\n          <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ios\n      <span class=\"token punctuation\">-</span> <span class=\"token important\">*save_gems_cache_ios</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and deploy iOS ipa\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> bundle exec fastlane deploy\n          <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ios\n          <span class=\"token key atrule\">no_output_timeout</span><span class=\"token punctuation\">:</span> 10m\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">store_artifacts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ios/output/gym/$PROJECTNAME.ipa\n          <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> /$PROJECTNAME.ipa</code></pre></div>\n<p>We can’t re-use the workspace created in the <code>verify</code> job. This is a limitation of building the iOS app on Circle CI and one reason why iOS takes a little longer than Android. Fortunately, we <em>can</em> still cache the node modules so it’s not a total loss.</p>\n<p>Double check that the XCode version is the one you want.</p>\n<h4>iOS code signing</h4>\n<p>The pain point for iOS is going to be code signing. It’s pretty much always the pain point for iOS no matter how you deploy. Circle CI has decent docs for <a href=\"https://circleci.com/docs/2.0/ios-codesigning\">setting up code signing for iOS projects</a> so I won’t duplicate that here. It will take some time to set up and likely require some trial and error, so be patient and don’t get discouraged. You’ll be setting up fastlane match and turning off Automatic Code Signing in XCode.</p>\n<p>When you get code signing working (test with <code>fastlane assemble_build</code> locally), don’t forget to set these environment variables in Circle CI: <code>FASTLANE_USER</code>, <code>FASTLANE_PASSWORD</code>, and <code>MATCH_PASSWORD</code>.</p>\n<h4>Deploying the iOS app using fastlane</h4>\n<p>Here’s an example fastlane config for iOS.</p>\n<p>Replace <code>com.org_example.example</code> with your project name and double check the name of the provisioning profile. I’ve used <code>\"AppStore\"</code> here.</p>\n<p>Also replace <code>$PREFERRED_SCHEME</code> with the right build scheme (this is usually just the project name).</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># ios/fastlane/Fastfile</span>\ndesc <span class=\"token string-literal\"><span class=\"token string\">\"Push a new beta build to TestFlight\"</span></span>\nbefore_all <span class=\"token keyword\">do</span>\n  <span class=\"token comment\"># Sets up fastlane match on Circle CI</span>\n  <span class=\"token comment\"># for readonly code signing</span>\n  setup_circle_ci\n<span class=\"token keyword\">end</span>\n\ndesc <span class=\"token string-literal\"><span class=\"token string\">\"Build the iOS app\"</span></span>\nlane <span class=\"token symbol\">:assemble_build</span> <span class=\"token keyword\">do</span>\n  match<span class=\"token punctuation\">(</span><span class=\"token symbol\">type</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"appstore\"</span></span><span class=\"token punctuation\">)</span>\n  gym<span class=\"token punctuation\">(</span>\n    <span class=\"token symbol\">scheme</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"$PREFERRED_SCHEME\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token symbol\">export_method</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"app-store\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token symbol\">export_options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token symbol\">provisioningProfiles</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string-literal\"><span class=\"token string\">\"com.org_example.example\"</span></span> <span class=\"token operator\">=></span> <span class=\"token string-literal\"><span class=\"token string\">\"match AppStore com.org_example.example\"</span></span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span>\n\ndesc <span class=\"token string-literal\"><span class=\"token string\">\"Build and deploy to TestFlight\"</span></span>\nlane <span class=\"token symbol\">:deploy</span> <span class=\"token keyword\">do</span>\n  assemble_build\n  upload_to_testflight\n  <span class=\"token comment\"># Includes the git tag commit message,</span>\n  <span class=\"token comment\"># which has all the release notes</span>\n  slack<span class=\"token punctuation\">(</span><span class=\"token symbol\">message</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"App successfully released!\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h4>Slack notification</h4>\n<p>We’re using the iOS Fastfile to send the Slack notification. This is because iOS will always take longer to complete than Android due to the nature of iOS deployments. You could post a notification for both, but I just post one when both are done and assume iOS will take longer.</p>\n<p>Why is it safe to assume that? App Store Connect processes the app before allowing the app to be tested in TestFlight. You can opt to skip waiting for processing in fastlane, but then fastlane can’t notify the testers for you. The app isn’t usable in Testflight until processing is completed anyway, so I suggest waiting.</p>\n<p>Have a look at the <a href=\"https://docs.fastlane.tools/actions/slack/#slack\">slack action docs</a>. Create the webhook on Slack’s website and add that URL to the Circle CI Environment as <code>SLACK_URL</code>.</p>\n<p>If you don’t need the slack notification, you only need to remove that line in the iOS Fastfile.</p>\n<h3>Putting it all together</h3>\n<p>We’ve covered a lot, and it doesn’t all work yet. The final piece is to set up the workflow in Circle’s <code>config.yml</code> so things actually get trigged after pushing to GitHub. Here we go:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">workflows</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">verify</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># This job runs on all branches</span>\n          <span class=\"token comment\"># and for all tags</span>\n          <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> /\\d+\\.\\d+\\.\\d+/\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">deploy_android</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requires</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> verify\n          <span class=\"token comment\"># This job runs on the</span>\n          <span class=\"token comment\"># deploy-android branch</span>\n          <span class=\"token comment\"># and for tags</span>\n          <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> deploy<span class=\"token punctuation\">-</span>android\n            <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> /\\d+\\.\\d+\\.\\d+/\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">deploy_ios</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requires</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> verify\n          <span class=\"token comment\"># This job runs on the</span>\n          <span class=\"token comment\"># deploy-ios branch</span>\n          <span class=\"token comment\"># and for tags</span>\n          <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> deploy<span class=\"token punctuation\">-</span>ios\n            <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> /\\d+\\.\\d+\\.\\d+/</code></pre></div>\n<p>I’ve found it useful to have separate branches for deploying either android or ios on its own in case of errors. For instance, say android failed but iOS succeeded. You can keep pushing commits to <code>deploy-android</code> until it succeeds without changing anything else. I expect this will happen for you a few times in the beginning, but should happen less and less with experience as you work out the kinks.</p>\n<h2>Conclusion</h2>\n<p>Congratulations! If you’ve made it this far, you have a robust, single-command deployment process from commit to app store. TestFlight and Google Play have updated versions, GitHub has the release notes, Slack has been notified. All with one command: <code>yarn release</code> or <code>npm run release</code>.</p>\n<p>With this setup, the deployment for my most recent app takes about 8 minutes <sup><a href=\"#notes\">2</a></sup> from the time I run the command to both apps being available in the app stores. Your deployment time may vary depending on package size, but I suspect this will be an improvement over your current workflow.</p>\n<p>If you have questions or suggestions on how this workflow could be improved, I’m available on <a href=\"https://twitter.com/timmywil\">Twitter</a>.</p>\n<p>Thanks for reading.</p>\n<p><a name=\"notes\"></a></p>\n<details>\n<summary>Notes</summary>\n<style>small, small code { font-size: 80%; line-height: 1; }</style>\n<p><small><strong>1</strong>:\n<code>bundler</code> will already exist in the Circle CI images, so we won’t have to worry about installing it there, but the default version in Circle CI images is 1.x. We install a 1.x version of <code>bundler</code> in the project so we don’t have to struggle through updating <code>bundler</code> in the Circle CI images.\n</small></p>\n<p><small><strong>2</strong>:\nThis time is measured by adding the <code>yarn</code> command time to the measured times in Circle CI and subtracting the time it takes for Apple to process the build, which can vary. I sometimes get deployments that take 6 minutes and sometimes 10 minutes, mostly depending on whether dependencies have changed. By the way, the most impactful change I’ve made to keep deployments fast is committing <code>Pods</code> to source control. I know it feels wrong at first, but the <a href=\"https://guides.cocoapods.org/using/using-cocoapods.html#should-i-check-the-pods-directory-into-source-control\">cocoapods creators recommend it</a> and it makes things simple. Trust me, it cut my iOS build times in half.\n</small></p>\n</details>","frontmatter":{"title":"Automate React Native Deployment - Part 2","date":"May 15, 2019","description":null}}},"pageContext":{"slug":"/blog/Automate-React-Native-Deployment-Part-2/","previous":{"fields":{"slug":"/blog/Automate-React-Native-Deployment-Part-1/"},"frontmatter":{"title":"Automate React Native Deployment - Part 1"}},"next":{"fields":{"slug":"/blog/Panzoom-4.0-jquery-panzoom-without-the-jquery/"},"frontmatter":{"title":"Panzoom 4.0: jquery.panzoom without the jquery."}}}},"staticQueryHashes":["2149165137","495387789","63159454"],"slicesMap":{}}